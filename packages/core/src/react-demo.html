<!doctype html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>React Demo - Changebot Widgets</title>

  <!-- Load React from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Load Changebot components -->
  <script type="module" src="/build/widgets.esm.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .demo-header {
      background: linear-gradient(135deg, #61dafb 0%, #21a0c8 100%);
      color: white;
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .demo-header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .demo-header .badge-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .demo-header .badge-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .control-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .control-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .control-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .control-row:last-child {
      margin-bottom: 0;
    }

    .control-row label {
      min-width: 120px;
      font-size: 13px;
      color: #555;
    }

    .control-row select,
    .control-row input[type="text"],
    .control-row input[type="datetime-local"] {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background: white;
    }

    .control-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .control-row .btn {
      flex-shrink: 0;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #61dafb;
      color: #20232a;
    }

    .btn-primary:hover {
      background: #4fc3f7;
    }

    .btn-secondary {
      background: #e9ecef;
      color: #495057;
    }

    .btn-secondary:hover {
      background: #dee2e6;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-warning:hover {
      background: #dd6b20;
    }

    .btn-danger {
      background: #e53e3e;
      color: white;
    }

    .btn-danger:hover {
      background: #c53030;
    }

    .debug-panel {
      background: #20232a;
      color: #61dafb;
      border-radius: 12px;
      padding: 20px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      margin-top: 24px;
    }

    .debug-panel h3 {
      color: #61dafb;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .debug-row {
      display: flex;
      margin-bottom: 8px;
    }

    .debug-label {
      color: #88d4f7;
      min-width: 180px;
    }

    .debug-value {
      color: #98c379;
    }

    .debug-value.warning {
      color: #e5c07b;
    }

    .mock-data-info {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #3e4451;
    }

    .mock-data-info h4 {
      color: #61dafb;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .mock-item {
      display: flex;
      gap: 12px;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .mock-item .id {
      color: #5c6370;
      min-width: 30px;
    }

    .mock-item .title {
      color: #abb2bf;
      flex: 1;
    }

    .mock-item .date {
      color: #56b6c2;
    }

    .mock-item .target {
      color: #c678dd;
      min-width: 60px;
    }

    .css-vars-section {
      margin-top: 24px;
    }

    .css-vars-section summary {
      cursor: pointer;
      font-weight: 600;
      color: #333;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      list-style: none;
    }

    .css-vars-section summary::-webkit-details-marker {
      display: none;
    }

    .css-vars-section summary::before {
      content: '+ ';
    }

    .css-vars-section[open] summary::before {
      content: '- ';
    }

    .css-vars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      padding: 16px 0;
    }

    .css-var-input {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .css-var-input label {
      font-size: 11px;
      color: #666;
      font-family: monospace;
    }

    .css-var-input input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }

    .react-note {
      background: #282c34;
      color: #abb2bf;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 13px;
      border-left: 4px solid #61dafb;
    }

    .react-note code {
      background: #3e4451;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Generate mock data with dynamic dates
    function generateMockData() {
      const now = Date.now();
      const day = 24 * 60 * 60 * 1000;

      return {
        widget: {
          title: 'Product Updates',
          subheading: 'Latest features and improvements',
          slug: 'react-demo',
          branded: false
        },
        publications: [
          {
            id: 1,
            title: "Today's Feature Release",
            content: '<p>We just launched a brand new feature!</p>',
            display_date: new Date().toISOString().split('T')[0],
            published_at: new Date().toISOString(),
            expires_on: null,
            highlight_target: 'banner',
            hosted_url: null,
            tags: [{ id: 1, name: 'Feature', color: '#10b981' }]
          },
          {
            id: 2,
            title: 'Performance Improvements (3 days ago)',
            content: '<p>Loading times reduced by 40%.</p>',
            display_date: new Date(now - 3 * day).toISOString().split('T')[0],
            published_at: new Date(now - 3 * day).toISOString(),
            expires_on: null,
            highlight_target: 'toast',
            hosted_url: null,
            tags: [{ id: 2, name: 'Performance', color: '#3b82f6' }]
          },
          {
            id: 3,
            title: 'Bug Fixes (1 week ago)',
            content: '<p>Fixed several reported issues.</p>',
            display_date: new Date(now - 7 * day).toISOString().split('T')[0],
            published_at: new Date(now - 7 * day).toISOString(),
            expires_on: null,
            highlight_target: null,
            hosted_url: null,
            tags: [{ id: 3, name: 'Bug Fix', color: '#ef4444' }]
          },
          {
            id: 4,
            title: 'New Dashboard (2 weeks ago)',
            content: '<p>Redesigned analytics dashboard.</p>',
            display_date: new Date(now - 14 * day).toISOString().split('T')[0],
            published_at: new Date(now - 14 * day).toISOString(),
            expires_on: null,
            highlight_target: null,
            hosted_url: null,
            tags: [{ id: 1, name: 'Feature', color: '#10b981' }]
          },
          {
            id: 5,
            title: 'API Updates (1 month ago)',
            content: '<p>New API endpoints.</p>',
            display_date: new Date(now - 30 * day).toISOString().split('T')[0],
            published_at: new Date(now - 30 * day).toISOString(),
            expires_on: null,
            highlight_target: null,
            hosted_url: null,
            tags: [{ id: 4, name: 'API', color: '#8b5cf6' }]
          }
        ]
      };
    }

    const mockData = generateMockData();
    const SCOPE = 'react-demo';
    const LS_KEY = `changebot:lastViewed:${SCOPE}`;

    function App() {
      // Component visibility state
      const [showBadge, setShowBadge] = useState(true);
      const [showPanel, setShowPanel] = useState(true);
      const [showBanner, setShowBanner] = useState(true);
      const [showToast, setShowToast] = useState(true);

      // Component options
      const [badgeShowCount, setBadgeShowCount] = useState(true);
      const [panelMode, setPanelMode] = useState('drawer-right');
      const [bannerPosition, setBannerPosition] = useState('top');
      const [toastPosition, setToastPosition] = useState('bottom-right');

      // Theme state
      const [themeMode, setThemeMode] = useState('fixed');
      const [fixedTheme, setFixedTheme] = useState('catppuccin-mocha');
      const [lightTheme, setLightTheme] = useState('catppuccin-latte');
      const [darkTheme, setDarkTheme] = useState('catppuccin-mocha');

      // Custom date
      const [customDate, setCustomDate] = useState('');

      // Debug state
      const [debugInfo, setDebugInfo] = useState({});

      // Refs for component methods
      const panelRef = useRef(null);
      const bannerRef = useRef(null);
      const toastRef = useRef(null);

      // Get theme props based on mode
      const getThemeProps = () => {
        if (themeMode === 'fixed') {
          return { theme: fixedTheme };
        }
        return { light: lightTheme, dark: darkTheme };
      };

      // Calculate debug info
      const refreshDebug = () => {
        const raw = localStorage.getItem(LS_KEY);
        const lastViewed = raw ? parseInt(raw) : null;
        let count = 0;
        if (lastViewed) {
          count = mockData.publications.filter(p => {
            const pubTime = new Date(p.published_at).getTime();
            return pubTime > lastViewed;
          }).length;
        }

        setDebugInfo({
          raw: raw || '(not set)',
          formatted: raw ? new Date(parseInt(raw)).toLocaleString() : '(not set)',
          count,
          theme: themeMode === 'fixed' ? fixedTheme : `light: ${lightTheme}, dark: ${darkTheme}`
        });
      };

      useEffect(() => {
        refreshDebug();
      }, [themeMode, fixedTheme, lightTheme, darkTheme]);

      // Last viewed controls
      const setLastViewed = (period) => {
        const now = Date.now();
        const day = 24 * 60 * 60 * 1000;
        let timestamp;

        switch (period) {
          case 'now': timestamp = now; break;
          case '1day': timestamp = now - day; break;
          case '7days': timestamp = now - 7 * day; break;
          case '30days': timestamp = now - 30 * day; break;
          case 'clear':
            localStorage.removeItem(LS_KEY);
            location.reload();
            return;
        }

        localStorage.setItem(LS_KEY, timestamp.toString());
        location.reload();
      };

      const setCustomDateValue = () => {
        if (customDate) {
          const timestamp = new Date(customDate).getTime();
          localStorage.setItem(LS_KEY, timestamp.toString());
          location.reload();
        }
      };

      // Action handlers
      const openPanel = () => {
        document.dispatchEvent(new CustomEvent('changebot:action', {
          detail: { type: 'openDisplay', scope: SCOPE },
          bubbles: true,
          composed: true
        }));
      };

      const triggerToast = async () => {
        if (toastRef.current && toastRef.current.show) {
          await toastRef.current.show(mockData.publications[1]);
        }
      };

      const triggerBanner = async () => {
        if (bannerRef.current && bannerRef.current.show) {
          await bannerRef.current.show(mockData.publications[0]);
        }
      };

      const themeProps = getThemeProps();

      return (
        <>
          <changebot-provider scope={SCOPE} mock-data={JSON.stringify(mockData)} />

          {showBanner && (
            <changebot-banner
              ref={bannerRef}
              scope={SCOPE}
              position={bannerPosition}
              {...themeProps}
            />
          )}

          <header className="demo-header">
            <h1>React Demo</h1>
            <div className="badge-wrapper">
              <span className="badge-label">Updates:</span>
              {showBadge && (
                <changebot-badge
                  scope={SCOPE}
                  show-count={badgeShowCount.toString()}
                  {...themeProps}
                />
              )}
            </div>
          </header>

          <div className="container">
            <div className="react-note">
              <strong>React Integration:</strong> Using web components with React refs.
              In production, use <code>@changebot/widgets-react</code> for better type support.
            </div>

            <div className="controls-grid">
              {/* Last Viewed */}
              <div className="control-section">
                <h3>Last Viewed Time</h3>
                <div className="button-row">
                  <button className="btn btn-secondary" onClick={() => setLastViewed('now')}>Now</button>
                  <button className="btn btn-secondary" onClick={() => setLastViewed('1day')}>1 Day</button>
                  <button className="btn btn-secondary" onClick={() => setLastViewed('7days')}>7 Days</button>
                  <button className="btn btn-secondary" onClick={() => setLastViewed('30days')}>30 Days</button>
                  <button className="btn btn-danger" onClick={() => setLastViewed('clear')}>Clear</button>
                </div>
                <div className="control-row" style={{ marginTop: 12 }}>
                  <label>Custom:</label>
                  <input
                    type="datetime-local"
                    value={customDate}
                    onChange={(e) => setCustomDate(e.target.value)}
                  />
                  <button className="btn btn-primary" onClick={setCustomDateValue}>Set</button>
                </div>
              </div>

              {/* Theme */}
              <div className="control-section">
                <h3>Theme</h3>
                <div className="control-row">
                  <label>Mode:</label>
                  <select value={themeMode} onChange={(e) => setThemeMode(e.target.value)}>
                    <option value="fixed">Fixed Theme</option>
                    <option value="auto">Light/Dark Auto</option>
                  </select>
                </div>
                {themeMode === 'fixed' ? (
                  <div className="control-row">
                    <label>Theme:</label>
                    <select value={fixedTheme} onChange={(e) => setFixedTheme(e.target.value)}>
                      <optgroup label="Light">
                        <option value="catppuccin-latte">Catppuccin Latte</option>
                        <option value="gruvbox-light">Gruvbox Light</option>
                        <option value="solarized-light">Solarized Light</option>
                        <option value="everforest-light">Everforest Light</option>
                        <option value="frost">Frost</option>
                      </optgroup>
                      <optgroup label="Dark">
                        <option value="catppuccin-frappe">Catppuccin Frappe</option>
                        <option value="catppuccin-macchiato">Catppuccin Macchiato</option>
                        <option value="catppuccin-mocha">Catppuccin Mocha</option>
                        <option value="gruvbox-dark">Gruvbox Dark</option>
                        <option value="dracula">Dracula</option>
                        <option value="nord">Nord</option>
                        <option value="solarized-dark">Solarized Dark</option>
                        <option value="everforest-dark">Everforest Dark</option>
                        <option value="tokyo-night">Tokyo Night</option>
                        <option value="cyberpunk">Cyberpunk</option>
                      </optgroup>
                    </select>
                  </div>
                ) : (
                  <>
                    <div className="control-row">
                      <label>Light:</label>
                      <select value={lightTheme} onChange={(e) => setLightTheme(e.target.value)}>
                        <option value="catppuccin-latte">Catppuccin Latte</option>
                        <option value="gruvbox-light">Gruvbox Light</option>
                        <option value="solarized-light">Solarized Light</option>
                        <option value="everforest-light">Everforest Light</option>
                        <option value="frost">Frost</option>
                      </select>
                    </div>
                    <div className="control-row">
                      <label>Dark:</label>
                      <select value={darkTheme} onChange={(e) => setDarkTheme(e.target.value)}>
                        <option value="catppuccin-frappe">Catppuccin Frappe</option>
                        <option value="catppuccin-macchiato">Catppuccin Macchiato</option>
                        <option value="catppuccin-mocha">Catppuccin Mocha</option>
                        <option value="gruvbox-dark">Gruvbox Dark</option>
                        <option value="dracula">Dracula</option>
                        <option value="nord">Nord</option>
                        <option value="solarized-dark">Solarized Dark</option>
                        <option value="everforest-dark">Everforest Dark</option>
                        <option value="tokyo-night">Tokyo Night</option>
                        <option value="cyberpunk">Cyberpunk</option>
                      </select>
                    </div>
                  </>
                )}
              </div>

              {/* Components */}
              <div className="control-section">
                <h3>Components</h3>
                <div className="control-row">
                  <input type="checkbox" checked={showBadge} onChange={(e) => setShowBadge(e.target.checked)} />
                  <label>Badge</label>
                  <input type="checkbox" checked={badgeShowCount} onChange={(e) => setBadgeShowCount(e.target.checked)} style={{ marginLeft: 'auto' }} />
                  <label style={{ minWidth: 'auto' }}>Count</label>
                </div>
                <div className="control-row">
                  <input type="checkbox" checked={showPanel} onChange={(e) => setShowPanel(e.target.checked)} />
                  <label>Panel</label>
                  <select value={panelMode} onChange={(e) => setPanelMode(e.target.value)} style={{ marginLeft: 'auto', flex: 'none', width: 140 }}>
                    <option value="drawer-right">Drawer Right</option>
                    <option value="drawer-left">Drawer Left</option>
                    <option value="modal">Modal</option>
                  </select>
                </div>
                <div className="control-row">
                  <input type="checkbox" checked={showBanner} onChange={(e) => setShowBanner(e.target.checked)} />
                  <label>Banner</label>
                  <select value={bannerPosition} onChange={(e) => setBannerPosition(e.target.value)} style={{ marginLeft: 'auto', flex: 'none', width: 140 }}>
                    <option value="top">Top</option>
                    <option value="bottom">Bottom</option>
                  </select>
                </div>
                <div className="control-row">
                  <input type="checkbox" checked={showToast} onChange={(e) => setShowToast(e.target.checked)} />
                  <label>Toast</label>
                  <select value={toastPosition} onChange={(e) => setToastPosition(e.target.value)} style={{ marginLeft: 'auto', flex: 'none', width: 140 }}>
                    <option value="bottom-right">Bottom Right</option>
                    <option value="bottom-left">Bottom Left</option>
                    <option value="top-right">Top Right</option>
                    <option value="top-left">Top Left</option>
                  </select>
                </div>
              </div>

              {/* Actions */}
              <div className="control-section">
                <h3>Actions</h3>
                <div className="button-row">
                  <button className="btn btn-primary" onClick={openPanel}>Open Panel</button>
                  <button className="btn btn-success" onClick={triggerToast}>Show Toast</button>
                  <button className="btn btn-warning" onClick={triggerBanner}>Show Banner</button>
                </div>
                <div className="button-row" style={{ marginTop: 12 }}>
                  <button className="btn btn-secondary" onClick={refreshDebug}>Refresh Debug</button>
                  <button className="btn btn-danger" onClick={() => setLastViewed('clear')}>Reset All</button>
                </div>
              </div>
            </div>

            {/* Debug Panel */}
            <div className="debug-panel">
              <h3>Debug Info</h3>
              <div className="debug-row">
                <span className="debug-label">Last Viewed (raw):</span>
                <span className={`debug-value ${debugInfo.raw === '(not set)' ? 'warning' : ''}`}>{debugInfo.raw}</span>
              </div>
              <div className="debug-row">
                <span className="debug-label">Last Viewed (formatted):</span>
                <span className="debug-value">{debugInfo.formatted}</span>
              </div>
              <div className="debug-row">
                <span className="debug-label">Calculated Count:</span>
                <span className="debug-value">{debugInfo.count}</span>
              </div>
              <div className="debug-row">
                <span className="debug-label">Theme:</span>
                <span className="debug-value">{debugInfo.theme}</span>
              </div>
              <div className="debug-row">
                <span className="debug-label">localStorage Key:</span>
                <span className="debug-value">{LS_KEY}</span>
              </div>

              <div className="mock-data-info">
                <h4>Mock Data Publications</h4>
                {mockData.publications.map(p => (
                  <div className="mock-item" key={p.id}>
                    <span className="id">#{p.id}</span>
                    <span className="title">{p.title}</span>
                    <span className="target">{p.highlight_target || '-'}</span>
                    <span className="date">{new Date(p.published_at).toLocaleDateString()}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {showPanel && (
            <changebot-panel
              ref={panelRef}
              scope={SCOPE}
              mode={panelMode}
              {...themeProps}
            />
          )}

          {showToast && (
            <changebot-toast
              ref={toastRef}
              scope={SCOPE}
              position={toastPosition}
              {...themeProps}
            />
          )}
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>
